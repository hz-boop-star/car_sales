# 汽车销售管理系统 - 功能验证手册

## 📋 验证前准备

### 1. 启动数据库
确保 openGauss/PostgreSQL 数据库已启动，并执行了初始化脚本：
```bash
# 数据库初始化脚本位置
database/init.sql
```

### 2. 启动后端
```bash
cd backend
./mvnw.cmd spring-boot:run
# 或者
./start-dev.cmd
```
**验证**：看到 "Started CarSalesApplication" 表示启动成功
**访问**：http://localhost:8080

### 3. 启动前端
```bash
cd frontend
pnpm install  # 首次运行
pnpm dev
```
**访问**：http://localhost:5173

---

## 🧪 功能验证清单

### 阶段 1：用户登录与权限（5分钟）

#### 1.1 管理员登录
1. 打开浏览器访问：http://localhost:5173
2. 输入用户名：`admin`
3. 输入密码：`123456`
4. 点击"登录"

**预期结果**：
- ✅ 登录成功，跳转到仪表盘页面
- ✅ 左侧菜单显示所有功能（车辆管理、客户管理、订单管理）
- ✅ 右上角显示用户名"管理员"

#### 1.2 销售员登录
1. 登出当前用户
2. 输入用户名：`sales`
3. 输入密码：`123456`
4. 点击"登录"

**预期结果**：
- ✅ 登录成功
- ✅ 可以访问所有功能（本系统销售员和管理员权限相同）

---

### 阶段 2：车辆管理（10分钟）

#### 2.1 查看车辆列表
1. 点击左侧菜单"车辆管理"
2. 查看车辆列表

**预期结果**：
- ✅ 显示车辆列表（如果有测试数据）
- ✅ 表格包含：VIN码、品牌、型号、颜色、年份、价格、状态
- ✅ 状态显示为不同颜色的标签（在库-绿色、锁定-橙色、已售-灰色）

#### 2.2 添加车辆
1. 点击"新增车辆"按钮
2. 填写表单：
   - VIN码：`TEST001` （必填，唯一）
   - 品牌：`奔驰`
   - 型号：`E300L`
   - 颜色：`黑色`
   - 年份：`2024`
   - 价格：`450000`
3. 点击"确定"

**预期结果**：
- ✅ 提示"添加成功"
- ✅ 列表中出现新车辆
- ✅ 状态自动为"在库"（绿色标签）

#### 2.3 搜索车辆
1. 在搜索框输入品牌：`奔驰`
2. 点击"查询"

**预期结果**：
- ✅ 只显示品牌为"奔驰"的车辆

3. 清空品牌，设置价格区间：
   - 最低价格：`400000`
   - 最高价格：`500000`
4. 点击"查询"

**预期结果**：
- ✅ 只显示价格在 40-50 万之间的车辆

#### 2.4 编辑车辆
1. 点击某辆车的"编辑"按钮
2. 修改价格为：`460000`
3. 点击"确定"

**预期结果**：
- ✅ 提示"更新成功"
- ✅ 列表中价格已更新

#### 2.5 Excel 导入（可选）
1. 点击"导入 Excel"按钮
2. 选择一个 Excel 文件（需要包含：VIN、品牌、型号、价格等列）
3. 点击"上传"

**预期结果**：
- ✅ 显示导入结果（成功数量、失败数量）
- ✅ 列表中出现导入的车辆

#### 2.6 Excel 导出
1. 点击"导出"按钮

**预期结果**：
- ✅ 浏览器下载一个 Excel 文件
- ✅ 文件包含当前筛选条件下的所有车辆数据

#### 2.7 删除车辆（测试约束）
1. 尝试删除一辆"在库"状态的车辆
2. 点击"删除"按钮，确认删除

**预期结果**：
- ✅ 删除成功

3. 尝试删除一辆"已售"状态的车辆

**预期结果**：
- ✅ 删除失败，提示"已售车辆无法删除"

---

### 阶段 3：客户管理（5分钟）

#### 3.1 查看客户列表
1. 点击左侧菜单"客户管理"
2. 查看客户列表

**预期结果**：
- ✅ 显示客户列表
- ✅ 表格包含：姓名、手机号、身份证号、性别、地址

#### 3.2 添加客户
1. 点击"新增客户"按钮
2. 填写表单：
   - 姓名：`张三`
   - 手机号：`13800138000`（必填，唯一）
   - 身份证号：`110101199001011234`（必填，唯一）
   - 性别：`男`
   - 地址：`北京市朝阳区`
3. 点击"确定"

**预期结果**：
- ✅ 提示"添加成功"
- ✅ 列表中出现新客户

#### 3.3 搜索客户
1. 在"姓名"搜索框输入：`张`
2. 点击"查询"

**预期结果**：
- ✅ 显示所有姓名包含"张"的客户（模糊搜索）

3. 清空姓名，在"手机号"搜索框输入：`13800138000`
4. 点击"查询"

**预期结果**：
- ✅ 只显示手机号为 13800138000 的客户（精确搜索）

#### 3.4 编辑客户
1. 点击某个客户的"编辑"按钮
2. 修改地址
3. 点击"确定"

**预期结果**：
- ✅ 提示"更新成功"
- ✅ 列表中地址已更新

#### 3.5 删除客户（测试约束）
1. 尝试删除一个没有订单的客户

**预期结果**：
- ✅ 删除成功

2. 尝试删除一个有订单的客户

**预期结果**：
- ✅ 删除失败，提示"该客户有关联订单，无法删除"

---

### 阶段 4：订单管理（核心功能，15分钟）

#### 4.1 创建订单（完整流程）
1. 点击左侧菜单"订单管理"
2. 点击"创建订单"按钮

**步骤 1：选择客户**
1. 在搜索框输入客户姓名或手机号
2. 点击"查询"
3. 点击某个客户所在的行（高亮显示）
4. 点击"下一步"

**预期结果**：
- ✅ 进入步骤 2

**步骤 2：选择车辆**
1. 查看车辆列表（只显示"在库"状态的车辆）
2. 可以按品牌搜索
3. 点击某辆车所在的行（高亮显示）
4. 点击"下一步"

**预期结果**：
- ✅ 进入步骤 3
- ✅ 只能看到"在库"状态的车辆

**步骤 3：确认订单**
1. 查看客户信息（只读）
2. 查看车辆信息（只读）
3. 输入优惠金额：`10000`
4. 查看成交价（自动计算 = 原价 - 优惠）
5. 选择订单日期（默认今天）
6. 输入备注（可选）
7. 点击"提交订单"

**预期结果**：
- ✅ 提示"订单创建成功"
- ✅ 自动跳转到订单列表
- ✅ 列表中出现新订单

#### 4.2 验证订单创建后的状态变化
1. 返回"车辆管理"页面
2. 找到刚才购买的车辆

**预期结果**：
- ✅ 车辆状态已变为"已售"（灰色标签）
- ✅ 该车辆在"创建订单"时不再显示

#### 4.3 查看订单列表
1. 点击左侧菜单"订单管理"
2. 查看订单列表

**预期结果**：
- ✅ 显示所有订单
- ✅ 表格包含：订单号、客户姓名、客户电话、车辆品牌、车辆型号、VIN码、成交价、销售员、订单日期、状态

#### 4.4 搜索订单
1. 选择日期区间（开始日期 - 结束日期）
2. 点击"查询"

**预期结果**：
- ✅ 只显示该日期区间内的订单

3. 选择销售员（下拉列表）
4. 点击"查询"

**预期结果**：
- ✅ 只显示该销售员的订单

5. 选择订单状态（已完成/已取消）
6. 点击"查询"

**预期结果**：
- ✅ 只显示该状态的订单

#### 4.5 查看订单详情
1. 点击某个订单的"详情"按钮

**预期结果**：
- ✅ 弹出对话框显示完整订单信息
- ✅ 包含：订单号、日期、状态、客户信息、车辆信息、价格信息、销售员、备注

#### 4.6 测试并发订单（重要！）
1. 打开两个浏览器窗口
2. 同时登录两个不同的销售员账号
3. 两个窗口同时尝试购买同一辆车

**预期结果**：
- ✅ 只有一个订单创建成功
- ✅ 另一个提示"车辆状态不可售"

---

### 阶段 5：统计报表（5分钟）

#### 5.1 查看仪表盘
1. 点击左侧菜单"数据概览"

**预期结果**：
- ✅ 显示统计卡片：
  - 总车辆数
  - 可售车辆数
  - 已售车辆数
  - 总收入（万元）
- ✅ 显示品牌销量占比饼图
- ✅ 显示月度销售趋势图（柱状图+折线图）

#### 5.2 验证统计数据准确性
1. 手动计算车辆管理中的车辆数量
2. 对比仪表盘中的数字

**预期结果**：
- ✅ 数字一致

3. 查看订单管理中的订单
4. 对比品牌销量饼图

**预期结果**：
- ✅ 各品牌销量与订单数量一致

---

## 🔍 数据库层验证（高级，5分钟）

### 验证存储过程
1. 连接数据库
2. 执行查询：
```sql
-- 查看订单创建前的车辆状态
SELECT id, vin, status FROM car_info WHERE vin = 'TEST001';

-- 手动调用存储过程创建订单
SELECT * FROM proc_create_order(
    2,  -- 销售员ID
    1,  -- 客户ID
    1,  -- 车辆ID
    450000  -- 成交价
);

-- 查看订单创建后的车辆状态
SELECT id, vin, status FROM car_info WHERE vin = 'TEST001';
```

**预期结果**：
- ✅ 车辆状态从 0（在库）变为 2（已售）
- ✅ 返回新订单ID

### 验证视图
```sql
-- 查询销售统计视图
SELECT * FROM v_sales_statistics;

-- 查询月度销售趋势视图
SELECT * FROM v_monthly_sales_trend;
```

**预期结果**：
- ✅ 视图返回聚合后的统计数据
- ✅ 数据与订单表一致

### 验证索引
```sql
-- 查看所有索引
SELECT tablename, indexname FROM pg_indexes 
WHERE schemaname = 'public' 
ORDER BY tablename, indexname;
```

**预期结果**：
- ✅ 看到 idx_car_vin, idx_customer_phone, idx_order_date 等索引

### 验证主键（无自增）
```sql
-- 查看表结构
\d car_info
\d customer
\d sales_order
```

**预期结果**：
- ✅ 主键类型为 BIGINT
- ✅ 没有 SERIAL 或 AUTO_INCREMENT

---

## ✅ 验证总结

完成以上所有步骤后，你应该验证了：

### 功能层面
- ✅ 用户登录与权限控制
- ✅ 车辆 CRUD 操作
- ✅ 车辆搜索（品牌、价格区间、状态）
- ✅ 车辆导入导出
- ✅ 客户 CRUD 操作
- ✅ 客户搜索（姓名模糊、手机号精确）
- ✅ 订单创建（三步向导）
- ✅ 订单查询（日期、销售员、状态）
- ✅ 订单详情查看
- ✅ 统计报表（仪表盘、图表）

### 数据库层面
- ✅ 存储过程正确执行
- ✅ 视图正确聚合数据
- ✅ 索引已创建
- ✅ 主键使用雪花算法（无自增）
- ✅ 外键约束生效
- ✅ 唯一约束生效
- ✅ 检查约束生效

### 业务逻辑
- ✅ 订单创建后车辆状态自动更新
- ✅ 已售车辆无法删除
- ✅ 有订单的客户无法删除
- ✅ 非在库车辆无法创建订单
- ✅ 并发订单防护（行锁）
- ✅ VIN、手机号、身份证号唯一性

---

## 🎬 演示建议

### 演示顺序（5分钟）
1. **登录** → 展示权限控制
2. **仪表盘** → 展示统计图表
3. **创建订单** → 展示完整业务流程（三步向导）
4. **验证状态变化** → 展示车辆状态从"在库"变"已售"
5. **数据库查询** → 展示存储过程、视图、索引

### 重点强调
- ✅ 使用存储过程实现订单创建（课程要求）
- ✅ 使用视图实现统计查询（课程要求）
- ✅ 主键使用雪花算法，无自增（课程要求）
- ✅ 完整的约束体系（外键、唯一、检查）
- ✅ 前后端分离架构
- ✅ 响应式界面设计

---

## 🐛 常见问题

### 1. 登录失败
- 检查后端是否启动
- 检查数据库是否有初始用户数据

### 2. 创建订单失败
- 确保选择的车辆状态为"在库"
- 确保客户和车辆都已选择

### 3. 图表不显示
- 检查是否有订单数据
- 打开浏览器控制台查看错误

### 4. 数据库连接失败
- 检查 application-dev.yml 中的数据库配置
- 确保数据库已启动

---

## 📝 验证记录表

| 功能模块 | 验证项 | 状态 | 备注 |
|---------|--------|------|------|
| 用户认证 | 管理员登录 | ⬜ |  |
| 用户认证 | 销售员登录 | ⬜ |  |
| 车辆管理 | 添加车辆 | ⬜ |  |
| 车辆管理 | 编辑车辆 | ⬜ |  |
| 车辆管理 | 删除车辆 | ⬜ |  |
| 车辆管理 | 搜索车辆 | ⬜ |  |
| 车辆管理 | 导入导出 | ⬜ |  |
| 客户管理 | 添加客户 | ⬜ |  |
| 客户管理 | 编辑客户 | ⬜ |  |
| 客户管理 | 删除客户 | ⬜ |  |
| 客户管理 | 搜索客户 | ⬜ |  |
| 订单管理 | 创建订单 | ⬜ |  |
| 订单管理 | 查看订单 | ⬜ |  |
| 订单管理 | 搜索订单 | ⬜ |  |
| 订单管理 | 订单详情 | ⬜ |  |
| 统计报表 | 仪表盘 | ⬜ |  |
| 统计报表 | 图表显示 | ⬜ |  |
| 数据库 | 存储过程 | ⬜ |  |
| 数据库 | 视图查询 | ⬜ |  |
| 数据库 | 索引验证 | ⬜ |  |
| 数据库 | 约束验证 | ⬜ |  |

打印这个表格，验证时打勾，确保不遗漏任何功能！
