# 订单管理模块

## 功能概述

订单管理模块提供了完整的订单查询和创建功能，包括订单列表展示、多条件搜索、订单详情查看和订单创建向导。

## 主要功能

### 1. 订单列表页面（OrderList.vue）

#### 1.1 订单列表展示
- 显示所有订单信息，包括：
  - 订单号
  - 客户姓名和电话
  - 车辆信息（品牌、型号、VIN码）
  - 成交价
  - 销售员
  - 订单日期
  - 订单状态（已完成/已取消）
- 支持表格排序和数据加载状态显示
- 操作列包含"详情"按钮

#### 1.2 搜索功能
- **日期区间搜索**：选择开始日期和结束日期进行范围查询
- **销售员筛选**：下拉选择特定销售员查看其订单
- **状态筛选**：筛选已完成或已取消的订单
- 支持重置搜索条件

#### 1.3 分页功能
- 支持自定义每页显示条数（10/20/50/100）
- 显示总记录数
- 支持页码跳转

#### 1.4 订单详情查看
- 点击"详情"按钮弹出对话框
- 使用描述列表展示完整订单信息：
  - 订单基本信息（订单号、日期、状态）
  - 客户信息（姓名、电话）
  - 车辆信息（品牌、型号、VIN码）
  - 价格信息（原价、优惠金额、成交价）
  - 销售员信息
  - 备注信息

#### 1.5 创建订单入口
- 右上角"创建订单"按钮
- 点击后跳转到订单创建向导页面

### 2. 订单创建向导（CreateOrder.vue）

#### 2.1 步骤式创建流程
使用 Element Plus Steps 组件实现三步创建流程：
1. 选择客户
2. 选择车辆
3. 确认订单

#### 2.2 步骤 1：选择客户
- **客户搜索**：
  - 支持按姓名搜索
  - 支持按手机号搜索
  - 查询按钮触发搜索
- **客户列表**：
  - 表格展示客户信息（姓名、手机号、身份证号、地址）
  - 支持单选（点击行选中）
  - 高亮显示当前选中的客户
- **下一步条件**：必须选择一个客户才能进入下一步

#### 2.3 步骤 2：选择车辆
- **车辆筛选**：
  - 自动筛选状态为"在库"（status=0）的车辆
  - 支持按品牌搜索
  - 查询按钮触发搜索
- **车辆列表**：
  - 表格展示车辆信息（VIN码、品牌、型号、颜色、年份、价格）
  - 支持单选（点击行选中）
  - 高亮显示当前选中的车辆
- **下一步条件**：必须选择一个车辆才能进入下一步

#### 2.4 步骤 3：确认订单
- **客户信息展示**（只读）：
  - 客户姓名
  - 手机号
- **车辆信息展示**（只读）：
  - 车辆品牌和型号
  - VIN码
  - 原价
- **订单信息编辑**：
  - **优惠金额**（必填）：
    - 数字输入框
    - 最小值：0
    - 最大值：车辆原价
    - 精度：2位小数
    - 修改后自动计算成交价
  - **成交价**（只读）：自动计算 = 原价 - 优惠金额
  - **订单日期**（必填）：日期选择器，默认当天
  - **备注**（可选）：多行文本输入
- **表单验证**：
  - 优惠金额必填
  - 订单日期必填

#### 2.5 操作按钮
- **上一步**：返回上一步（步骤 1 不显示）
- **下一步**：进入下一步（步骤 1 和 2 显示，需满足条件）
- **提交订单**：提交订单数据（步骤 3 显示）
- **取消**：返回订单列表页面

#### 2.6 订单提交
- 调用后端 POST /api/orders 接口
- 提交数据包括：
  - customerId：客户ID
  - carId：车辆ID
  - actualPrice：成交价
  - orderDate：订单日期
  - remark：备注
- 提交成功后：
  - 显示成功消息
  - 自动跳转到订单列表页面
- 提交失败后：
  - 显示错误消息
  - 保持在当前页面

## API 接口

### 订单列表查询
```
GET /api/orders
参数：
  - startDate: 开始日期（可选）
  - endDate: 结束日期（可选）
  - salesUserId: 销售员ID（可选）
  - status: 订单状态（可选，1-已完成，2-已取消）
  - current: 当前页码
  - size: 每页条数
响应：Result<Page<OrderDetail>>
```

### 订单详情查询
```
GET /api/orders/{id}
响应：Result<OrderDetail>
```

### 创建订单
```
POST /api/orders
请求体：
  - customerId: 客户ID
  - carId: 车辆ID
  - actualPrice: 成交价
  - orderDate: 订单日期（可选，默认当天）
  - remark: 备注（可选）
响应：Result<Order>
```

### 查询销售员列表
```
GET /api/users
参数：
  - role: SALESPERSON
响应：Result<List<User>>
```

### 查询客户列表
```
GET /api/customers
参数：
  - name: 姓名（可选）
  - phone: 手机号（可选）
  - current: 当前页码
  - size: 每页条数
响应：Result<Page<Customer>>
```

### 查询可售车辆列表
```
GET /api/cars
参数：
  - status: 0（在库）
  - brand: 品牌（可选）
  - current: 当前页码
  - size: 每页条数
响应：Result<Page<Car>>
```

## 数据验证

### 前端验证
- 优惠金额：必填，范围 0 到车辆原价
- 订单日期：必填
- 客户选择：必须选择一个客户
- 车辆选择：必须选择一个车辆

### 后端验证
- 车辆状态检查：只能销售"在库"状态的车辆
- 车辆状态更新：订单创建成功后，车辆状态自动更新为"已售"
- 事务处理：通过存储过程确保订单创建和车辆状态更新的原子性

## 需求映射

### 订单列表页面
- **需求 4.7**：显示关联的用户、客户、车辆信息 ✅
- **需求 4.8**：支持按日期区间筛选 ✅
- **需求 4.9**：支持按销售员筛选 ✅
- **需求 4.10**：支持按订单状态筛选 ✅

### 订单创建向导
- **需求 4.1**：通过存储过程创建订单（后端实现）✅
- **需求 8.3**：提供订单创建向导 ✅
- **需求 8.4**：选择客户时提供可搜索下拉列表 ✅
- **需求 8.5**：选择车辆时只显示"在库"状态的车辆 ✅

## 技术实现

- **框架**：Vue 3 + TypeScript
- **UI 组件**：Element Plus
- **状态管理**：Vue Composition API
- **HTTP 请求**：Axios
- **路由**：Vue Router
- **表单验证**：Element Plus Form Validation

## 用户体验优化

### 订单列表
- 加载状态显示
- 表格高亮当前行
- 价格格式化显示（千分位）
- 状态标签颜色区分
- 操作反馈及时

### 订单创建
- 步骤进度可视化
- 当前步骤高亮
- 下一步按钮根据条件禁用
- 表格单选高亮
- 自动计算成交价
- 提交加载状态
- 成功后自动跳转

## 注意事项

1. **车辆状态限制**：
   - 订单创建时只能选择"在库"状态的车辆
   - 订单创建成功后，车辆状态自动变为"已售"
   - 如果车辆已被其他订单占用，创建会失败

2. **优惠金额限制**：
   - 不能为负数
   - 不能超过车辆原价
   - 修改后自动重新计算成交价

3. **并发控制**：
   - 后端通过存储过程和行锁防止并发问题
   - 如果两个用户同时尝试购买同一辆车，只有一个会成功

4. **数据完整性**：
   - 订单创建和车辆状态更新在同一事务中
   - 任何失败都会回滚整个操作

## 测试建议

### 功能测试
1. **订单列表**：
   - 测试日期区间筛选
   - 测试销售员筛选
   - 测试状态筛选
   - 测试分页功能
   - 测试订单详情查看

2. **订单创建**：
   - 测试客户搜索和选择
   - 测试车辆搜索和选择
   - 测试优惠金额计算
   - 测试表单验证
   - 测试订单提交

### 边界测试
1. 空数据列表
2. 优惠金额边界值（0、原价）
3. 并发创建订单
4. 网络错误处理

### 集成测试
1. 前后端联调
2. 存储过程调用
3. 车辆状态更新
4. 事务回滚测试
